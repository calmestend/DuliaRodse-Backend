DROP DATABASE IF EXISTS DULIARODSE;
CREATE DATABASE DULIARODSE;
USE DULIARODSE;

CREATE TABLE USUARIO(
    ID_USU INT NOT NULL AUTO_INCREMENT,
    NOM_USU VARCHAR(25),
	TIPO_USU INT(3),
	PASS_USU VARCHAR(255),
	PRIMARY KEY (ID_USU),
	UNIQUE INDEX(NOM_USU)
);

INSERT INTO USUARIO VALUES (NULL, 'adminSuc1', 1,  'admin');
INSERT INTO USUARIO VALUES (NULL, 'adminSuc2', 1, 'admin');
INSERT INTO USUARIO VALUES (NULL, 'adminSuc3', 1, 'admin');

INSERT INTO USUARIO VALUES (NULL, 'jMartinez', 2, 'password');
INSERT INTO USUARIO VALUES (NULL, 'mGarcia', 2, 'password');
INSERT INTO USUARIO VALUES (NULL, 'jCarlos', 2, 'password');

CREATE TABLE ESTADO(
	CVE_ESTADO INT(3),
	NOM_ESTADO VARCHAR(25),
	PRIMARY KEY (CVE_ESTADO)
);

INSERT INTO ESTADO VALUES (1, 'Aguascalientes');
INSERT INTO ESTADO VALUES (2, 'Baja California');
INSERT INTO ESTADO VALUES (3, 'Baja California Sur');
INSERT INTO ESTADO VALUES (4, 'Campeche');
INSERT INTO ESTADO VALUES (5, 'Chiapas');
INSERT INTO ESTADO VALUES (6, 'Chihuahua');
INSERT INTO ESTADO VALUES (7, 'Ciudad de México');
INSERT INTO ESTADO VALUES (8, 'Coahuila');
INSERT INTO ESTADO VALUES (9, 'Colima');
INSERT INTO ESTADO VALUES (10, 'Durango');
INSERT INTO ESTADO VALUES (11, 'Estado de México');
INSERT INTO ESTADO VALUES (12, 'Guanajuato');
INSERT INTO ESTADO VALUES (13, 'Guerrero');
INSERT INTO ESTADO VALUES (14, 'Hidalgo');
INSERT INTO ESTADO VALUES (15, 'Jalisco');
INSERT INTO ESTADO VALUES (16, 'Michoacán');
INSERT INTO ESTADO VALUES (17, 'Morelos');
INSERT INTO ESTADO VALUES (18, 'Nayarit');
INSERT INTO ESTADO VALUES (19, 'Nuevo León');
INSERT INTO ESTADO VALUES (20, 'Oaxaca');
INSERT INTO ESTADO VALUES (21, 'Puebla');
INSERT INTO ESTADO VALUES (22, 'Querétaro');
INSERT INTO ESTADO VALUES (23, 'Quintana Roo');
INSERT INTO ESTADO VALUES (24, 'San Luis Potosí');
INSERT INTO ESTADO VALUES (25, 'Sinaloa');
INSERT INTO ESTADO VALUES (26, 'Sonora');
INSERT INTO ESTADO VALUES (27, 'Tabasco');
INSERT INTO ESTADO VALUES (28, 'Tamaulipas');
INSERT INTO ESTADO VALUES (29, 'Tlaxcala');
INSERT INTO ESTADO VALUES (30, 'Veracruz');
INSERT INTO ESTADO VALUES (31, 'Yucatán');
INSERT INTO ESTADO VALUES (32, 'Zacatecas');

CREATE TABLE CIUDAD(
	CVE_CIUDAD INT(3),
	NOM_CIUDAD VARCHAR(50),
	CVE_ESTADO INT(3),
	PRIMARY KEY (CVE_CIUDAD),
	FOREIGN KEY (CVE_ESTADO) REFERENCES ESTADO (CVE_ESTADO)
);

INSERT INTO CIUDAD VALUES (1, 'Aguascalientes', 1); INSERT INTO CIUDAD VALUES (2, 'Calvillo', 1);
INSERT INTO CIUDAD VALUES (3, 'Mexicali', 2); INSERT INTO CIUDAD VALUES (4, 'Ensenada', 2);
INSERT INTO CIUDAD VALUES (5, 'La Paz', 3); INSERT INTO CIUDAD VALUES (6, 'Cabo San Lucas', 3);
INSERT INTO CIUDAD VALUES (7, 'Campeche', 4); INSERT INTO CIUDAD VALUES (8, 'Ciudad del Carmen', 4);
INSERT INTO CIUDAD VALUES (9, 'Tuxtla Gutierrez', 5); INSERT INTO CIUDAD VALUES (10, 'San Cristóbal de las Casas', 5);
INSERT INTO CIUDAD VALUES (11, 'Chihuahua', 6); INSERT INTO CIUDAD VALUES (12, 'Ciudad Juárez', 6);
INSERT INTO CIUDAD VALUES (13, 'Ciudad de México', 7); INSERT INTO CIUDAD VALUES (14, 'Tlalnepantla', 7);
INSERT INTO CIUDAD VALUES (15, 'Saltillo', 8); INSERT INTO CIUDAD VALUES (16, 'Torreón', 8);
INSERT INTO CIUDAD VALUES (17, 'Colima', 9); INSERT INTO CIUDAD VALUES (18, 'Manzanillo', 9);
INSERT INTO CIUDAD VALUES (19, 'Durango', 10); INSERT INTO CIUDAD VALUES (20, 'Gómez Palacio', 10);
INSERT INTO CIUDAD VALUES (21, 'Toluca', 11); INSERT INTO CIUDAD VALUES (22, 'Naucalpan', 11);
INSERT INTO CIUDAD VALUES (23, 'Guanajuato', 12); INSERT INTO CIUDAD VALUES (24, 'León', 12);
INSERT INTO CIUDAD VALUES (25, 'Chilpancingo', 13); INSERT INTO CIUDAD VALUES (26, 'Acapulco', 13);
INSERT INTO CIUDAD VALUES (27, 'Pachuca', 14); INSERT INTO CIUDAD VALUES (28, 'Tulancingo', 14);
INSERT INTO CIUDAD VALUES (29, 'Guadalajara', 15); INSERT INTO CIUDAD VALUES (30, 'Zapopan', 15);
INSERT INTO CIUDAD VALUES (31, 'Morelia', 16); INSERT INTO CIUDAD VALUES (32, 'Uruapan', 16);
INSERT INTO CIUDAD VALUES (33, 'Cuernavaca', 17); INSERT INTO CIUDAD VALUES (34, 'Tepoztlán', 17);
INSERT INTO CIUDAD VALUES (35, 'Tepic', 18); INSERT INTO CIUDAD VALUES (36, 'Bahía de Banderas', 18);
INSERT INTO CIUDAD VALUES (37, 'Monterrey', 19); INSERT INTO CIUDAD VALUES (38, 'San Pedro Garza García', 19);
INSERT INTO CIUDAD VALUES (39, 'Oaxaca', 20); INSERT INTO CIUDAD VALUES (40, 'Huajuapan de León', 20);
INSERT INTO CIUDAD VALUES (41, 'Puebla', 21); INSERT INTO CIUDAD VALUES (42, 'Cholula', 21);
INSERT INTO CIUDAD VALUES (43, 'Santiago de Querétaro', 22); INSERT INTO CIUDAD VALUES (44, 'San Juan del Río', 22);
INSERT INTO CIUDAD VALUES (45, 'Cancún', 23); INSERT INTO CIUDAD VALUES (46, 'Playa del Carmen', 23);
INSERT INTO CIUDAD VALUES (47, 'San Luis Potosí', 24); INSERT INTO CIUDAD VALUES (48, 'Ciudad Valles', 24);
INSERT INTO CIUDAD VALUES (49, 'Culiacán', 25); INSERT INTO CIUDAD VALUES (50, 'Mazatlán', 25);
INSERT INTO CIUDAD VALUES (51, 'Hermosillo', 26); INSERT INTO CIUDAD VALUES (52, 'Guaymas', 26);
INSERT INTO CIUDAD VALUES (53, 'Villahermosa', 27); INSERT INTO CIUDAD VALUES (54, 'Cárdenas', 27);
INSERT INTO CIUDAD VALUES (55, 'Ciudad Victoria', 28); INSERT INTO CIUDAD VALUES (56, 'Tampico', 28);
INSERT INTO CIUDAD VALUES (57, 'Tlaxcala', 29); INSERT INTO CIUDAD VALUES (58, 'Apizaco', 29);
INSERT INTO CIUDAD VALUES (59, 'Xalapa', 30); INSERT INTO CIUDAD VALUES (60, 'Veracruz', 30);
INSERT INTO CIUDAD VALUES (61, 'Mérida', 31); INSERT INTO CIUDAD VALUES (62, 'Progreso', 31);
INSERT INTO CIUDAD VALUES (63, 'Zacatecas', 32); INSERT INTO CIUDAD VALUES (64, 'Guadalupe', 32);

CREATE TABLE CATEGORIA(
	ID_CAT CHAR(5),
	NOM_CAT CHAR(25),
	PRIMARY KEY (ID_CAT),
	UNIQUE INDEX(NOM_CAT)
);

INSERT INTO CATEGORIA VALUES ('c_001', 'Exfoliantes');
INSERT INTO CATEGORIA VALUES ('c_002', 'Dermatologico');
INSERT INTO CATEGORIA VALUES ('c_003', 'Hidratantes');
INSERT INTO CATEGORIA VALUES ('c_004', 'Antioxidantes');
INSERT INTO CATEGORIA VALUES ('c_005', 'Antiinflamatorios');
INSERT INTO CATEGORIA VALUES ('c_006', 'Regeneradores');

CREATE TABLE CLIENTE(
	ID_CLIE INT NOT NULL AUTO_INCREMENT,
	NI_CLIE VARCHAR(25) NOT NULL,
	AP_CLIE VARCHAR(25) NOT NULL,
	AM_CLIE VARCHAR(25) NOT NULL,
	COL_CLIE VARCHAR(25),
	CALLE_CLIE VARCHAR(25),
	NOINT_CLIE CHAR(5),
	NOEXT_CLIE CHAR(5),
	CP_CLIE CHAR(5),
	EMAIL_CLIE VARCHAR(50) NOT NULL,
	ID_USU INT NOT NULL,
	CVE_CIUDAD INT(3),
	RFC_CLIE CHAR(15),
	TEL_CLIE CHAR(10) NOT NULL,
	PRIMARY KEY (ID_CLIE),
	UNIQUE INDEX(EMAIL_CLIE),
	FOREIGN KEY (ID_USU) REFERENCES USUARIO (ID_USU),
	FOREIGN KEY (CVE_CIUDAD) REFERENCES CIUDAD (CVE_CIUDAD)
);

INSERT INTO CLIENTE VALUES (NULL, 'Juan', 'Martinez', 'Garcia', 'Centro', 'Hidalgo', '123', '456', '76000', 'juan@gmail.com', '4', 43, 'MNASDF0452HDFR', '4431234567');

INSERT INTO CLIENTE VALUES (NULL, 'Maria', 'Garcia', 'Lopez', 'Centro', 'Hidalgo', '123', '456', '76000', 'mariaGarcia@gmail.com', '5', 43, 'ASKFDJ0123HDFR', '6691230842');

INSERT INTO CLIENTE VALUES (NULL, 'Juan', 'Carlos', 'Garcia', 'Centro', 'Hidalgo', '123', '456', '76000', 'juancarlos@gmail.com', '6', 43, 'NSDFML0123HDFR', '6181234567');

CREATE TABLE SUCURSAL(
	NO_SUC INT(3),
	COL_SUC VARCHAR(25),
	CALLE_SUC VARCHAR(25),
	NOINT_SUC CHAR(5),
	NOEXT_SUC CHAR(5),
	CP_SUC CHAR(5),
	CVE_CIUDAD INT(3),
	PRIMARY KEY (NO_SUC),
	FOREIGN KEY (CVE_CIUDAD) REFERENCES CIUDAD (CVE_CIUDAD)
);


INSERT INTO SUCURSAL VALUES (1, 'La Popular', 'Ignacio Ramirez', '123', '456', '76000', 43);
INSERT INTO SUCURSAL VALUES (2, 'El Mirador', 'Emiliano Zapata', '789', '012', '78000', 47);
INSERT INTO SUCURSAL VALUES (3, '3 Marias', 'Benito Juarez', '345', '678', '58000', 31);

CREATE TABLE PRODUCTO(
	ID_PRO INT NOT NULL AUTO_INCREMENT, 
	NOM_PRO VARCHAR(50),
	GRAM_PRO DECIMAL(7,2),
	COS_PRO DECIMAL(7,2),
	PREC_PRO DECIMAL(7,2),
	IMG_PRO CHAR(50),
	ID_CAT CHAR(5),
	AROMA_PRO VARCHAR(25),
	ACTIVO INT(1),
	PRIMARY KEY (ID_PRO),
	UNIQUE INDEX(NOM_PRO),
	FOREIGN KEY (ID_CAT) REFERENCES CATEGORIA(ID_CAT) ON DELETE RESTRICT ON UPDATE CASCADE
);

INSERT INTO PRODUCTO VALUES (1, 'Jabon de avena', 100,150.50,220.50, 'jabon_avena.jpg', 'c_001', 'Avena', 1);
INSERT INTO PRODUCTO VALUES (2, 'Jabon de miel', 100, 170.50,250.00, 'jabon_miel.jpg', 'c_003', 'Miel', 1);
INSERT INTO PRODUCTO VALUES (3, 'Jabon de rosa mosqueta', 100, 175.00,250.50, 'jabon_rosa.jpg', 'c_006', 'Rosa Mosqueta',1);
INSERT INTO PRODUCTO VALUES (4, 'Jabon de calendula', 100, 200.50,290.00, 'jabon_calendula.jpg', 'c_005', 'Calendula', 1);
INSERT INTO PRODUCTO VALUES (5, 'Jabon de lavanda y manzanilla', 100, 100.00,175.00, 'jabon_lavanda.jpg', 'c_002', 'Lavanda y Manzanilla', 1);
INSERT INTO PRODUCTO VALUES (6, 'Jabon de menta', 100, 200.00,275.50, 'jabon_menta.jpg', 'c_004', 'Menta', 1);
INSERT INTO PRODUCTO VALUES (7, 'Jabon de canela', 100, 200.50,275.00, 'jabon_canela.jpg', 'c_004', 'Canela', 1);
INSERT INTO PRODUCTO VALUES (8, 'Jabon de naranja', 100, 150.50,235.50, 'jabon_naranja.jpg', 'c_004', 'Naranja', 1);
INSERT INTO PRODUCTO VALUES (9, 'Jabon de coco', 100, 200.50,280.00, 'jabon_coco.jpg', 'c_003', 'Coco', 1);
INSERT INTO PRODUCTO VALUES (10, 'Jabon de limon', 100, 175.00, 250.00, 'jabon_limon.jpg', 'c_004', 'Limon', 1);


CREATE TABLE INVENTARIO(
	NO_INV INT(3),
	EXIST_INV DECIMAL(10,0),
	NO_SUC INT(3),
	ID_PRO INT,
	PRIMARY KEY (NO_INV),
	FOREIGN KEY (ID_PRO) REFERENCES PRODUCTO (ID_PRO) ON DELETE SET NULL,
	FOREIGN KEY (NO_SUC) REFERENCES SUCURSAL (NO_SUC)
);

INSERT INTO INVENTARIO VALUES (1, 100, 1, 1);
INSERT INTO INVENTARIO VALUES (2, 150, 1, 2);
INSERT INTO INVENTARIO VALUES (3, 200, 1, 3);
INSERT INTO INVENTARIO VALUES (4, 120, 1, 4);
INSERT INTO INVENTARIO VALUES (5, 180, 1, 5);
INSERT INTO INVENTARIO VALUES (6, 90, 1, 6);
INSERT INTO INVENTARIO VALUES (7, 160, 1, 7);
INSERT INTO INVENTARIO VALUES (8, 140, 1, 8);
INSERT INTO INVENTARIO VALUES (9, 110, 1, 9);
INSERT INTO INVENTARIO VALUES (10, 170, 1, 10);

INSERT INTO INVENTARIO VALUES (11, 80, 2, 1);
INSERT INTO INVENTARIO VALUES (12, 130, 2, 2);
INSERT INTO INVENTARIO VALUES (13, 190, 2, 3);
INSERT INTO INVENTARIO VALUES (14, 100, 2, 4);
INSERT INTO INVENTARIO VALUES (15, 150, 2, 5);
INSERT INTO INVENTARIO VALUES (16, 120, 2, 6);
INSERT INTO INVENTARIO VALUES (17, 170, 2, 7);
INSERT INTO INVENTARIO VALUES (18, 140, 2, 8);
INSERT INTO INVENTARIO VALUES (19, 110, 2, 9);
INSERT INTO INVENTARIO VALUES (20, 160, 2, 10);

INSERT INTO INVENTARIO VALUES (21, 70, 3, 1);
INSERT INTO INVENTARIO VALUES (22, 120, 3, 2);
INSERT INTO INVENTARIO VALUES (23, 180, 3, 3);
INSERT INTO INVENTARIO VALUES (24, 90, 3, 4);
INSERT INTO INVENTARIO VALUES (25, 140, 3, 5);
INSERT INTO INVENTARIO VALUES (26, 110, 3, 6);
INSERT INTO INVENTARIO VALUES (27, 160, 3, 7);
INSERT INTO INVENTARIO VALUES (28, 130, 3, 8);
INSERT INTO INVENTARIO VALUES (29, 100, 3, 9);
INSERT INTO INVENTARIO VALUES (30, 150, 3, 10);

CREATE TABLE VENTA(
	CVE_VENTA INT NOT NULL AUTO_INCREMENT,
	FEC_VENTA DATE,
	PAGO_VENTA DEC(7,2),
	ID_CLIE INT,
	PRIMARY KEY (CVE_VENTA),
	FOREIGN KEY (ID_CLIE) REFERENCES CLIENTE(ID_CLIE)
);

CREATE TABLE PAGO(
	CVE_PAGO INT NOT NULL AUTO_INCREMENT,
	FEC_PAGO DATE,
	CANT_PAGO DECIMAL(10,2),
	TIP_PAGO CHAR(25),
	CVE_VENTA INT(3),
	PRIMARY KEY (CVE_PAGO),
	FOREIGN KEY (CVE_VENTA) REFERENCES VENTA(CVE_VENTA)
);

CREATE TABLE FACTURA(
	CVE_FACTURA INT NOT NULL AUTO_INCREMENT,
	FEC_FACTURA DATE,
	CVE_VENTA INT(3),
	PRIMARY KEY (CVE_FACTURA),
	FOREIGN KEY (CVE_VENTA) REFERENCES PAGO (CVE_VENTA)
);

CREATE TABLE VENTA_INVENTARIO(
	CVE_VENTA INT(3),
	NO_INV INT(3),
	CANT_PRO INT(3),
	FOREIGN KEY (CVE_VENTA) REFERENCES VENTA(CVE_VENTA)ON DELETE RESTRICT,
	FOREIGN KEY (NO_INV) REFERENCES INVENTARIO(NO_INV)
);

CREATE TABLE ESCALA (
	ID_ESC INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
	VAL_ESC INT
);

INSERT INTO ESCALA (VAL_ESC) VALUES (1);
INSERT INTO ESCALA (VAL_ESC) VALUES (2);
INSERT INTO ESCALA (VAL_ESC) VALUES (3);
INSERT INTO ESCALA (VAL_ESC) VALUES (4);
INSERT INTO ESCALA (VAL_ESC) VALUES (5);

CREATE TABLE REVIEW (
	ID_REV INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
	ID_ESC INT,
	ID_CLIE INT,
	ID_PRO INT,
	COM_REV LONGTEXT,
	FOREIGN KEY (ID_ESC) REFERENCES ESCALA(ID_ESC),
	FOREIGN KEY (ID_CLIE) REFERENCES CLIENTE(ID_CLIE),
	FOREIGN KEY (ID_PRO) REFERENCES PRODUCTO(ID_PRO) ON DELETE RESTRICT
);


DELIMITER //
CREATE PROCEDURE INGRESAR_CLIENTE(
    IN NOMBRE_USUARIO VARCHAR(50),
    IN CONTRASENA_USUARIO VARCHAR(25),
    IN NOMBRE_CLIENTE VARCHAR(25),
    IN APELLIDO_PATERNO_CLIENTE VARCHAR(25),
    IN APELLIDO_MATERNO_CLIENTE VARCHAR(25),
    IN EMAIL_CLIENTE VARCHAR(50),
    IN TEL_CLIENTE CHAR(10)
)
BEGIN
    DECLARE ID_USUARIO INT;
    INSERT INTO USUARIO (ID_USU, NOM_USU, TIPO_USU, PASS_USU) VALUES (NULL, NOMBRE_USUARIO, 2, CONTRASENA_USUARIO);
    SET ID_USUARIO = (SELECT ID_USU FROM USUARIO WHERE NOM_USU = NOMBRE_USUARIO);
    INSERT INTO CLIENTE (ID_CLIE, NI_CLIE, AP_CLIE, AM_CLIE, EMAIL_CLIE, ID_USU, TEL_CLIE) VALUES (NULL, NOMBRE_CLIENTE, APELLIDO_PATERNO_CLIENTE, APELLIDO_MATERNO_CLIENTE, EMAIL_CLIENTE, ID_USUARIO, TEL_CLIENTE);
END //

CREATE VIEW ULTIMAS_VENTAS_POR_CLIENTE AS
WITH VENTAS_ORDENADAS AS (
	SELECT *,
		ROW_NUMBER() OVER (PARTITION BY ID_CLIE ORDER BY FEC_VENTA DESC, CVE_VENTA DESC) AS FILA
	FROM VENTA
)
SELECT *
FROM VENTAS_ORDENADAS
WHERE FILA = 1;

CREATE VIEW HISTORIAL_DE_COMPRAS AS
SELECT VENTA.CVE_VENTA, VENTA.ID_CLIE, VENTA.FEC_VENTA, VENTA_INVENTARIO.NO_INV, PRODUCTO.ID_PRO, PRODUCTO.NOM_PRO, PRODUCTO.PREC_PRO, VENTA_INVENTARIO.CANT_PRO, VENTA.PAGO_VENTA 
FROM VENTA 
INNER JOIN VENTA_INVENTARIO ON VENTA.CVE_VENTA = VENTA_INVENTARIO.CVE_VENTA 
INNER JOIN INVENTARIO ON VENTA_INVENTARIO.NO_INV = INVENTARIO.NO_INV 
INNER JOIN PRODUCTO ON INVENTARIO.ID_PRO = PRODUCTO.ID_PRO;

CREATE VIEW DATOS_FACTURA AS
SELECT CLIENTE.ID_CLIE, CLIENTE.NI_CLIE , CLIENTE.AP_CLIE, CLIENTE.AM_CLIE, CLIENTE.COL_CLIE, CLIENTE.CALLE_CLIE, CLIENTE.NOINT_CLIE, CLIENTE.NOEXT_CLIE, CLIENTE.CP_CLIE, CLIENTE.EMAIL_CLIE,
CIUDAD.NOM_CIUDAD, ESTADO.NOM_ESTADO,
VENTA.CVE_VENTA , VENTA.FEC_VENTA, VENTA.PAGO_VENTA,
PAGO.CVE_PAGO, PAGO.CANT_PAGO, PAGO.TIP_PAGO,
FACTURA.CVE_FACTURA,
VENTA_INVENTARIO.CANT_PRO, INVENTARIO.NO_INV,
PRODUCTO.ID_PRO, PRODUCTO.NOM_PRO, PRODUCTO.PREC_PRO,
(PRODUCTO.PREC_PRO * CANT_PRO) AS IMPORTE
FROM CLIENTE
INNER JOIN CIUDAD ON CLIENTE.CVE_CIUDAD = CIUDAD.CVE_CIUDAD
INNER JOIN ESTADO ON CIUDAD.CVE_ESTADO = ESTADO.CVE_ESTADO
INNER JOIN VENTA ON CLIENTE.ID_CLIE = VENTA.ID_CLIE
INNER JOIN PAGO ON VENTA.CVE_VENTA = PAGO.CVE_VENTA
INNER JOIN FACTURA ON VENTA.CVE_VENTA = FACTURA.CVE_VENTA
INNER JOIN VENTA_INVENTARIO ON VENTA.CVE_VENTA = VENTA_INVENTARIO.CVE_VENTA
INNER JOIN INVENTARIO ON VENTA_INVENTARIO.NO_INV = INVENTARIO.NO_INV
INNER JOIN PRODUCTO ON INVENTARIO.ID_PRO = PRODUCTO.ID_PRO;
